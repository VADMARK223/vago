<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Книга</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/github-dark.min.css">
    <script src="/static/js/highlight.min.js"></script>
</head>
<body>
{{ template "header" . }}

<main>
    <div class="container">
        <div style="display: flex; align-items: center;  justify-content: flex-start;  gap: 8px;  width: 100%; margin-bottom: var(--space-2)">
            <a href="#" class="btn btn-primary disabled" data-back>← Назад</a>
            <a href="/book" class="btn btn-primary">Оглавление</a>
            <span>Меню:</span>
            <form method="get" action="/book" style="flex: 1;">
                <label>
                    <select name="chapter_id" onchange="this.form.submit()">
                        <option value="0" {{ if eq $.chapter_id .ID }}selected{{ end }}>Оглавление</option>
                        {{ range .chapters }}
                        <option value="{{ .ID }}"
                                {{ if eq $.chapter_id .ID }}selected{{ end }}
                        >{{ if not .HideID }}{{ .ID }}. {{ end }} {{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </label>
            </form>
        </div>

        <div class="scrollable-wrapper">
            <div class="scrollable-content" id="scrollable">
                <div class="chapter">
                    {{ if eq .chapter_id 1 }}
                    {{ template "book.common" . }}
                    {{ else if eq .chapter_id 2 }}
                    {{ template "book.slices" . }}
                    {{ else if eq .chapter_id 3 }}
                    {{ template "book.arrays" . }}
                    {{ else if eq .chapter_id 4 }}
                    {{ template "book.maps" . }}
                    {{ else if eq .chapter_id 5 }}
                    {{ template "book.functions" . }}
                    {{ else if eq .chapter_id 6 }}
                    {{ template "book.interfaces" . }}
                    {{ else if eq .chapter_id 7 }}
                    {{ template "book.goroutines" . }}
                    {{ else if eq .chapter_id 8 }}
                    {{ template "book.scheduler" . }}
                    {{ else if eq .chapter_id 9 }}
                    {{ template "book.channels" . }}
                    {{ else if eq .chapter_id 10 }}
                    {{ template "book.sync" . }}
                    {{ else if eq .chapter_id 11 }}
                    {{ template "book.errors" . }}
                    {{ else if eq .chapter_id 12 }}
                    {{ template "book.defer" . }}
                    {{ else if eq .chapter_id 13 }}
                    {{ template "book.stack_heap" . }}
                    {{ else if eq .chapter_id 14 }}
                    {{ template "book.pointers" . }}
                    {{ else if eq .chapter_id 15 }}
                    {{ template "book.gc" . }}
                    {{ else if eq .chapter_id 16 }}
                    {{ template "book.context" . }}
                    {{ else if eq .chapter_id 17 }}
                    {{ template "book.strings" . }}
                    {{ else if eq .chapter_id 18 }}
                    {{ template "book.generics" . }}
                    {{ else if eq .chapter_id 19 }}
                    {{ template "book.select" . }}
                    {{ else if eq .chapter_id 20 }}
                    {{ template "book.testing" . }}
                    {{ else if eq .chapter_id 21 }}
                    {{ template "book.ci_cd" . }}
                    {{ else if eq .chapter_id 22 }}
                    {{ template "book.memory" . }}

                    {{ else if eq .chapter_id 100 }}
                    {{ template "book.cheat" . }}
                    {{ else if eq .chapter_id 101 }}
                    {{ template "task.practice" . }}
                    {{ else }}
                    <div>
                        {{ range .chapters }}
                        <a href="/book?chapter_id={{ .ID }}">{{ if not .HideID }}{{ .ID }}. {{ end }} {{ .Name
                            }}</a><br>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
            </div>
            <button class="scroll-top-btn" id="scrollTopBtn" title="Наверх">↑</button>
        </div>
    </div>
</main>

<script>hljs.highlightAll();</script>
<script type="module" src="/static/js/bundle.js"></script>

<script>
    (() => {
        const STORAGE_KEY = 'bookHistory';
        const backBtn = document.querySelector('[data-back]');

        if (!backBtn) return;

        const isBookPage = (url = location.pathname) =>
            url.startsWith('/book');

        const normalizeUrl = () =>
            location.pathname + location.search; // БЕЗ hash

        const loadHistory = () =>
            JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '[]');

        const saveHistory = (history) =>
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(history));

        const updateBackButton = () => {
            const history = loadHistory();
            if (history.length <= 1) {
                backBtn.classList.add('disabled');
            } else {
                backBtn.classList.remove('disabled');
            }
        };

        const pushToHistory = () => {
            if (!isBookPage()) {
                sessionStorage.removeItem(STORAGE_KEY);
                return;
            }

            const history = loadHistory();
            const current = normalizeUrl();

            if (history[history.length - 1] !== current) {
                history.push(current);
                saveHistory(history);
            }

            updateBackButton();
        };

        // Клик по кнопке Назад
        backBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (backBtn.classList.contains('disabled')) return;

            const history = loadHistory();
            history.pop(); // текущая
            const prev = history[history.length - 1];

            saveHistory(history);
            updateBackButton();

            if (prev) {
                location.href = prev;
            }
        });

        // Игнорируем переходы только по якорям
        window.addEventListener('hashchange', () => {
            updateBackButton();
        });

        // Навигация браузерной кнопкой
        window.addEventListener('popstate', () => {
            pushToHistory();
        });

        // Первый заход / переход
        document.addEventListener('DOMContentLoaded', () => {
            pushToHistory();
        });

        // Сброс истории при уходе из книги
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a[href]');
            if (!link) return;

            const href = link.getAttribute('href');
            if (!href || href.startsWith('#')) return;

            // абсолютный URL
            const url = new URL(href, location.origin);

            // уходим НЕ в /book
            if (!url.pathname.startsWith('/book')) {
                sessionStorage.removeItem(STORAGE_KEY);
            }
        });
    })();
</script>


</body>
</html>