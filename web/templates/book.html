<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Книга</title>
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/github-dark.min.css">
    <script src="/static/js/highlight.min.js"></script>
</head>
<body>
{{ template "header" . }}

<main>
    <div class="container">
        <div style="display: flex; align-items: center;  justify-content: flex-start;  gap: 8px;  width: 100%; margin-bottom: var(--space-2)">
            <a href="#" class="btn" data-back>← Назад</a>
            <a href="/book" class="btn">Оглавление</a>
            <span>Меню:</span>
            <form method="get" action="/book" style="flex: 1; display: flex; align-items: center;">
                <label>
                    <select name="chapter_id" onchange="this.form.submit()">
                        <option value="0" {{ if eq $.chapter_id .ID }}selected{{ end }}>Оглавление</option>
                        {{ range .chapters }}
                        <option value="{{ .ID }}"
                                {{ if eq $.chapter_id .ID }}selected{{ end }}
                        >{{ if not .HideID }}{{ .ID }}. {{ end }} {{ .Name }}
                        </option>
                        {{ end }}
                    </select>
                </label>
            </form>
        </div>

        <div class="scrollable-wrapper">
            <div class="scrollable-content" id="scrollable">
                <div class="chapter">
                    {{ if eq .chapter_id 1 }}
                    {{ template "book.common" . }}
                    {{ else if eq .chapter_id 2 }}
                    {{ template "book.slices" . }}
                    {{ else if eq .chapter_id 3 }}
                    {{ template "book.arrays" . }}
                    {{ else if eq .chapter_id 4 }}
                    {{ template "book.maps" . }}
                    {{ else if eq .chapter_id 5 }}
                    {{ template "book.functions" . }}
                    {{ else if eq .chapter_id 6 }}
                    {{ template "book.interfaces" . }}
                    {{ else if eq .chapter_id 7 }}
                    {{ template "book.goroutines" . }}
                    {{ else if eq .chapter_id 8 }}
                    {{ template "book.scheduler" . }}
                    {{ else if eq .chapter_id 9 }}
                    {{ template "book.channels" . }}
                    {{ else if eq .chapter_id 10 }}
                    {{ template "book.sync" . }}
                    {{ else if eq .chapter_id 11 }}
                    {{ template "book.errors" . }}
                    {{ else if eq .chapter_id 12 }}
                    {{ template "book.defer" . }}
                    {{ else if eq .chapter_id 13 }}
                    {{ template "book.stack_heap" . }}
                    {{ else if eq .chapter_id 14 }}
                    {{ template "book.pointers" . }}
                    {{ else if eq .chapter_id 15 }}
                    {{ template "book.gc" . }}
                    {{ else if eq .chapter_id 16 }}
                    {{ template "book.context" . }}
                    {{ else if eq .chapter_id 17 }}
                    {{ template "book.strings" . }}
                    {{ else if eq .chapter_id 18 }}
                    {{ template "book.generics" . }}
                    {{ else if eq .chapter_id 19 }}
                    {{ template "book.select" . }}
                    {{ else if eq .chapter_id 20 }}
                    {{ template "book.testing" . }}
                    {{ else if eq .chapter_id 21 }}
                    {{ template "book.ci_cd" . }}
                    {{ else if eq .chapter_id 22 }}
                    {{ template "book.memory" . }}

                    {{ else if eq .chapter_id 100 }}
                    {{ template "book.cheat" . }}
                    {{ else if eq .chapter_id 101 }}
                    {{ template "task.practice" . }}
                    {{ else }}
                    <div>
                        {{ range .chapters }}
                        <a href="/book?chapter_id={{ .ID }}">{{ if not .HideID }}{{ .ID }}. {{ end }} {{ .Name
                            }}</a><br>
                        {{ end }}
                    </div>
                    {{ end }}
                </div>
            </div>
            <button class="scroll-top-btn" id="scrollTopBtn" title="Наверх">↑</button>
        </div>
    </div>
</main>

{{ template "footer" . }}
<script>hljs.highlightAll();</script>
<script type="module" src="/static/js/bundle.js"></script>
<!--<script>
    document.addEventListener('DOMContentLoaded', () => {
        const backBtn = document.querySelector('[data-back]');
        if (!backBtn) return;

        const referrer = document.referrer;
        const inBook = referrer.includes('/book');
        const canGoBack = window.history.length > 1;
        console.log("window.history.length: ", window.history.length)

        if (!inBook || !canGoBack) {
            backBtn.classList.add('disabled');
            backBtn.setAttribute('aria-disabled', 'true');
            return;
        }

        backBtn.addEventListener('click', (e) => {
            e.preventDefault();
            history.back();
        });
    });
</script>-->


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const backBtn = document.querySelector('[data-back]');
        if (!backBtn) return;

        const BOOK_PREFIX = '/book';
        const path = location.pathname;
        const currentPage = location.pathname + location.search;
        const referrer = document.referrer;

        // если мы не в книге — кнопка не нужна
        if (!path.startsWith(BOOK_PREFIX)) {
            backBtn.classList.add('disabled');
            return;
        }

        // новый заход в книгу извне — сбрасываем историю
        const cameFromBook = referrer.includes(BOOK_PREFIX);
        if (!cameFromBook) {
            sessionStorage.removeItem('book:lastPage');
        }

        const lastPage = sessionStorage.getItem('book:lastPage');

        if (lastPage && lastPage !== currentPage) {
            backBtn.addEventListener('click', (e) => {
                e.preventDefault();
                location.href = lastPage;
            });
        } else {
            backBtn.classList.add('disabled');
        }

        // сохраняем страницу ТОЛЬКО если это не якорь
        if (!location.hash) {
            sessionStorage.setItem('book:lastPage', currentPage);
        }
    });
</script>

</body>
</html>