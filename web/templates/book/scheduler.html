{{ define "book.scheduler" }}
<h1>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (Scheduler)</h1>
<a href="#preemption">–í—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ (Preemption)</a>
<a href="#stealing">–í–æ—Ä–æ–≤—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã (Work stealing)</a>
<a href="#traps">–ß–∞—Å—Ç—ã–µ –ª–æ–≤—É—à–∫–∏</a>

<p><b>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go (runtime scheduler)</b> ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å <b>runtime, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—ã –ø–æ –ø–æ—Ç–æ–∫–∞–º –û–°</b>,
    —Ä–µ—à–∞—è:</p>
<ul>
    <li><i>–∫–æ–≥–¥–∞</i> –≤—ã–ø–æ–ª–Ω—è—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—É</li>
    <li><i>–≥–¥–µ</i> (–≤ –∫–∞–∫–æ–º –ø–æ—Ç–æ–∫–µ)</li>
    <li><i>—Å–∫–æ–ª—å–∫–æ</i> –≥–æ—Ä—É—Ç–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ</li>
</ul>
<p>–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å:<br>
    üëâ <b>–º–∏–ª–ª–∏–æ–Ω—ã –≥–æ—Ä—É—Ç–∏–Ω</b> ‚Üí <b>–¥–µ—Å—è—Ç–∫–∏ –ø–æ—Ç–æ–∫–æ–≤ –û–°</b> ‚Üí <b>–Ω–µ—Å–∫–æ–ª—å–∫–æ —è–¥–µ—Ä CPU</b>
</p>
<hr>
<h2>–ú–æ–¥–µ–ª—å G-M-P</h2>
<p>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ Go –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –º–æ–¥–µ–ª–∏ <b>GMP</b>:</p>
<p><b>G ‚Äî Goroutine</b></p>
<ul>
    <li>–õ—ë–≥–∫–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</li>
    <li>–ú–∞–ª–µ–Ω—å–∫–∏–π —Å—Ç–µ–∫ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ~2KB)</li>
    <li>–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç</li>
</ul>
<p><b>M ‚Äî Machine</b></p>
<ul>
    <li>–ü–æ—Ç–æ–∫ –û–° (OS thread)</li>
    <li>–ò–º–µ–Ω–Ω–æ –æ–Ω <b>–∏—Å–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥</b></li>
    <li>–ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (syscall, cgo)</li>
</ul>
<p><b>P ‚Äî Processor</b></p>
<ul>
    <li>–õ–æ–≥–∏—á–µ—Å–∫–∏–π ¬´–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä¬ª Go</li>
    <li>–•—Ä–∞–Ω–∏—Ç <b>–æ—á–µ—Ä–µ–¥—å –≥–æ—Ç–æ–≤—ã—Ö –≥–æ—Ä—É—Ç–∏–Ω</b></li>
    <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ P = <code>GOMAXPROCS</code></li>
</ul>
<p>üëâ <b>–ë–µ–∑ P –ø–æ—Ç–æ–∫ M –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å Go-–∫–æ–¥</b></p>
<h3>–ö–∞–∫ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–µ</h3>
<p>–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:</p>
<ol>
    <li><code>go func()</code> ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è <b>G</b></li>
    <li>G –∫–ª–∞–¥—ë—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –∫–∞–∫–æ–≥–æ-—Ç–æ <b>P</b></li>
    <li><b>M</b> –±–µ—Ä—ë—Ç <b>P</b></li>
    <li><b>M</b> –∏—Å–ø–æ–ª–Ω—è–µ—Ç <b>G</b></li>
    <li>G:
        <ul>
            <li>–∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è</li>
            <li>–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞—Å—å ‚Üí M –∏—â–µ—Ç –¥—Ä—É–≥—É—é G</li>
            <li>–æ—Ç–¥–∞–ª–∞ –∫–≤–∞–Ω—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å</li>
        </ul>
    </li>
</ol>

<hr>
<h2>GOMAXPROCS</h2>
<pre><code class="language-go">runtime.GOMAXPROCS(n)</code></pre>
<ul>
    <li>–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç <b>—Å–∫–æ–ª—å–∫–æ P</b> —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</li>
    <li>–ê –∑–Ω–∞—á–∏—Ç ‚Äî <b>—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω –º–æ–≥—É—Ç —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ</b></li>
</ul>
<p>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:</p>
<ul>
    <li><code>= –∫–æ–ª–∏—á–µ—Å—Ç–≤—É CPU —è–¥–µ—Ä</code></li>
</ul>
<p>1000 –≥–æ—Ä—É—Ç–∏–Ω + <code>GOMAXPROCS = 1</code><br>
    ‚Üí <b>–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</b>
</p>

<hr>
<h2 id="preemption">–í—ã—Ç–µ—Å–Ω—è—é—â–∞—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å</h2>
<h3>–†–∞–Ω—å—à–µ (–¥–æ 1.14)</h3>
<p>–ì–æ—Ä—É—Ç–∏–Ω–∞ —É—Å—Ç—É–ø–∞–ª–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ:</p>
<ul>
    <li>–ø—Ä–∏ syscall</li>
    <li>–ø—Ä–∏ channel ops</li>
    <li>–ø—Ä–∏ <code>time.Sleep</code></li>
    <li>–ø—Ä–∏ <code>runtime.Gosched()</code></li>
</ul>
<p>üî• –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π <code>for {}</code> –º–æ–≥ <b>—Å–ª–æ–º–∞—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</b></p>
<h3>–°–µ–π—á–∞—Å</h3>
<p>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ <b>–º–æ–∂–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—É</b>, –µ—Å–ª–∏ –æ–Ω–∞:</p>
<ul>
    <li>–¥–æ–ª–≥–æ –∫—Ä—É—Ç–∏—Ç—Å—è</li>
    <li>–Ω–µ –¥–µ–ª–∞–µ—Ç safe-points</li>
</ul>
<p>–ó–∞—á–µ–º</p>
<ul>
    <li>–Ω–µ –¥–∞—Ç—å –æ–¥–Ω–æ–π goroutine –∑–∞—Ö–≤–∞—Ç–∏—Ç—å CPU</li>
    <li>—Å–Ω–∏–∑–∏—Ç—å latency</li>
    <li>–æ–±–µ—Å–ø–µ—á–∏—Ç—å fairness</li>
    <li>–¥–∞—Ç—å GC –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏—Ä</li>
</ul>
<p>–£—Ä–æ–≤–µ–Ω—å</p>
<ul>
    <li><b>–≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ P</b></li>
    <li>–∫–∞—Å–∞–µ—Ç—Å—è <b>–≤—ã–ø–æ–ª–Ω—è—é—â–µ–π—Å—è goroutine</b></li>
</ul>
<p><b>–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:</b> üëâ <i>–û–¥–Ω–∞ goroutine —É—Å—Ç—É–ø–∞–µ—Ç –º–µ—Å—Ç–æ –¥—Ä—É–≥–æ–π</i></p>

<p>–≠—Ç–æ –æ–≥—Ä–æ–º–Ω—ã–π –ø–ª—é—Å –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.</p>

<hr>
<h2 id="stealing">Work stealing (–≤–æ—Ä–æ–≤—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã)</h2>
<p>–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É P.</p>
<p>–ó–∞—á–µ–º</p>
<ul>
    <li>–Ω–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—Ç—å —è–¥—Ä–∞–º</li>
    <li>—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å goroutine</li>
    <li>–∏–∑–±–µ–≥–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏</li>
</ul>
<p>–£—Ä–æ–≤–µ–Ω—å</p>
<ul>
    <li><b>–º–µ–∂–¥—É P</b></li>
    <li>–∫–∞—Å–∞–µ—Ç—Å—è <b>–æ—á–µ—Ä–µ–¥–µ–π goroutine</b></li>
</ul>
<p><b>–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:</b> üëâ <i>–°–≤–æ–±–æ–¥–Ω—ã–π P –∏—â–µ—Ç —Å–µ–±–µ —Ä–∞–±–æ—Ç—É</i></p>

<p>–ï—Å–ª–∏ —É P:</p>
<ul>
    <li>–æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞—è</li>
</ul>
<p>–û–Ω:</p>
<ul>
    <li><b>–≤–æ—Ä—É–µ—Ç –≥–æ—Ä—É—Ç–∏–Ω—ã —É –¥—Ä—É–≥–∏—Ö P</b></li>
</ul>
<p>‚û°Ô∏è –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ <b>–±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ª–æ–∫a</b></p>

<hr>
<h2>–ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
<h3>Syscall / I/O</h3>
<p>–ï—Å–ª–∏ M —É—à—ë–ª –≤ syscall:</p>
<ul>
    <li>–æ–Ω –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç P</li>
    <li>runtime —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π M</li>
    <li>P –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ G</li>
</ul>
<p>üëâ –ü–æ—ç—Ç–æ–º—É Go <b>–Ω–µ –±–æ–∏—Ç—Å—è –±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ I/O</b></p>

<h2>–ü–æ—á–µ–º—É –≥–æ—Ä—É—Ç–∏–Ω—ã —Ç–∞–∫–∏–µ –¥–µ—à—ë–≤—ã–µ</h2>
<table>
    <thead>
    <tr>
        <th>–ü–æ—Ç–æ–∫–∏ –û–°</th>
        <th>–ì–æ—Ä—É—Ç–∏–Ω—ã</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>–ë–æ–ª—å—à–æ–π —Å—Ç–µ–∫</td>
        <td>–ú–∞–ª–µ–Ω—å–∫–∏–π, —Ä–∞—Å—Ç—É—â–∏–π</td>
    </tr>
    <tr>
        <td>–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç</td>
        <td>–û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π</td>
    </tr>
    <tr>
        <td>–ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç—è–∂—ë–ª—ã–π</td>
        <td>–ö–æ–Ω—Ç–µ–∫—Å—Ç –ª—ë–≥–∫–∏–π</td>
    </tr>
    <tr>
        <td>–¢—ã—Å—è—á–∏ ‚Äî –ø—Ä–æ–±–ª–µ–º–∞</td>
        <td>–ú–∏–ª–ª–∏–æ–Ω—ã ‚Äî –Ω–æ—Ä–º–∞</td>
    </tr>
    </tbody>
</table>

<hr>
<h2 id="traps">–ß–∞—Å—Ç—ã–µ –ª–æ–≤—É—à–∫–∏</h2>
<h3>1. CPU-bound –∫–æ–¥ –±–µ–∑ yield</h3>
<pre><code class="language-go">for {
    // —Ç—è–∂—ë–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
}</code></pre>
<p>‚û°Ô∏è –¥–æ Go 1.14 ‚Äî –±–µ–¥–∞<br>
    ‚û°Ô∏è —Å–µ–π—á–∞—Å –ª—É—á—à–µ, –Ω–æ <b>–≤—Å—ë —Ä–∞–≤–Ω–æ –ø–ª–æ—Ö–æ</b></p>
<p>–†–µ—à–µ–Ω–∏–µ:</p>
<ul>
    <li>—Ä–∞–∑–±–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É</li>
    <li><code>runtime.Gosched()</code></li>
    <li>worker pool</li>
</ul>
<hr>
<h3>2. –õ–æ–∂–Ω–∞—è –≤–µ—Ä–∞ –≤ ¬´–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å¬ª</h3>
<pre><code class="language-go">GOMAXPROCS = 1</code></pre>
<p>
    ‚û°Ô∏è concurrency –µ—Å—Ç—å<br>
    ‚û°Ô∏è parallelism –Ω–µ—Ç
</p>

<hr>

<h3>3. –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≥–æ—Ä—É—Ç–∏–Ω ‚â† –±—ã—Å—Ç—Ä–µ–µ</h3>
<ul>
    <li>–∫–æ–Ω—Ç–µ–∫—Å—Ç-—Å–≤–∏—Ç—á–∏</li>
    <li>–¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ GC</li>
    <li>—Ä–æ—Å—Ç latency</li>
</ul>

<hr>
<h2>–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ</h2>
<ul>
    <li>Go –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <b>user-space scheduler</b></li>
    <li>–û—Å–Ω–æ–≤–∞–Ω –Ω–∞ <b>G-M-P</b></li>
    <li><code>P</code> = —É—Ä–æ–≤–µ–Ω—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞</li>
    <li>–ï—Å—Ç—å <b>preemption</b> –∏ <b>work stealing</b></li>
    <li>–ì–æ—Ä—É—Ç–∏–Ω—ã –¥–µ—à—ë–≤—ã–µ, –Ω–æ <b>–Ω–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</b></li>
</ul>

<hr>
<h2>Preemption vs Work stealing</h2>
<table>
    <thead>
    <tr>
        <th>–ö—Ä–∏—Ç–µ—Ä–∏–π</th>
        <th>Preemption</th>
        <th>Work stealing</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç</td>
        <td>–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç goroutine</td>
        <td>–ü–µ—Ä–µ–º–µ—â–∞–µ—Ç goroutine</td>
    </tr>
    <tr>
        <td>–ö–æ–≥–¥–∞</td>
        <td>Goroutine —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</td>
        <td>–£ P –Ω–µ—Ç —Ä–∞–±–æ—Ç—ã</td>
    </tr>
    <tr>
        <td>–£—Ä–æ–≤–µ–Ω—å</td>
        <td>–í–Ω—É—Ç—Ä–∏ P</td>
        <td>–ú–µ–∂–¥—É P</td>
    </tr>
    <tr>
        <td>–¶–µ–ª—å</td>
        <td>Fairness, latency</td>
        <td>–ë–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏</td>
    </tr>
    <tr>
        <td>–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç</td>
        <td>–í—ã–ø–æ–ª–Ω—è—é—â—É—é—Å—è goroutine</td>
        <td>–û—á–µ—Ä–µ–¥–∏ goroutine</td>
    </tr>
    <tr>
        <td>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ</td>
        <td>–î–∞</td>
        <td>–ù–µ—Ç (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)</td>
    </tr>
    <tr>
        <td>–ù–∞ –ø–∞–ª—å—Ü–∞—Ö</td>
        <td>–≠–π, —Ç—ã —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ —Ä–∞–±–æ—Ç–∞–µ—à—å, —É—Å—Ç—É–ø–∏ –º–µ—Å—Ç–æ</td>
        <td>–ú–Ω–µ –Ω–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å, –ø–æ–π–¥—É –∑–∞–±–µ—Ä—É —Ä–∞–±–æ—Ç—É —É —Å–æ—Å–µ–¥–∞</td>
    </tr>
    </tbody>
</table>
<h3>–û–Ω–∏ –Ω–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã ‚Äî –æ–Ω–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞</h3>
<p>–û—á–µ–Ω—å –≤–∞–∂–Ω–æ:</p>
<ul>
    <li><b>Preemption</b> —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É <i>¬´–æ–¥–Ω–∞ goroutine –≤—Å–µ—Ö –¥—É—à–∏—Ç¬ª</i></li>
    <li><b>Work stealing</b> —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É <i>¬´–æ–¥–Ω–æ —è–¥—Ä–æ –ø–∞—à–µ—Ç, –¥—Ä—É–≥–æ–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç¬ª</i></li>
</ul>
<p>–ë–µ–∑ –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö:</p>
<ul>
    <li>–Ω–µ—Ç fairness</li>
    <li>–Ω–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è</li>
</ul>


{{ end }}