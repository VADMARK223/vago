{{ define "book.stack_heap" }}
<h1>–°—Ç–µ–∫ –∏ –∫—É—á–∞ (Stack and heap)</h1>
<a href="#stack">–°—Ç–µ–∫</a>
<a href="#heap">–ö—É—á–∞</a>
<h2 id="stack">–°—Ç–µ–∫</h2>
<h3>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
<p><b>Stack (—Å—Ç–µ–∫)</b> ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç <b>–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ</b> –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:</p>
<ul>
    <li>–ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π</li>
    <li>–∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π</li>
    <li>–∞–¥—Ä–µ—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—Ç–∞</li>
    <li>–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</li>
</ul>
<p>üìå –í–∞–∂–Ω–æ: <b>—É –∫–∞–∂–¥–æ–π –≥–æ—Ä—É—Ç–∏–Ω—ã —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–µ–∫</b>.</p>

<h3>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</h3>
<h4>1. –ú–∞–ª–µ–Ω—å–∫–∏–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä</h4>
<p>–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç C/C++:</p>
<ul>
    <li>—Å—Ç–µ–∫ –≥–æ—Ä—É—Ç–∏–Ω—ã –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–º</li>
    <li>–ø—Ä–∏–º–µ—Ä–Ω–æ <b>2 KB</b></li>
    <li>—Ä–∞—Å—Ç—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏</li>
</ul>
<pre><code class="language-go">go func() {
    var a [1024]int // –Ω–æ—Ä–º–∞–ª—å–Ω–æ
    fmt.Println(a[0])
}()</code></pre>
<p>üëâ Go <b>–Ω–µ –ø–∞–¥–∞–µ—Ç —Å stack overflow</b>, –∫–∞–∫ C ‚Äî –æ–Ω —Ä–∞—Å—à–∏—Ä–∏—Ç —Å—Ç–µ–∫.</p>
<hr>
<h4>2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç —Å—Ç–µ–∫–∞</h4>
<p>–ï—Å–ª–∏ —Å—Ç–µ–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è:</p>
<ol>
    <li>Go runtime:
        <ul>
            <li>–≤—ã–¥–µ–ª—è–µ—Ç –Ω–æ–≤—ã–π —Å—Ç–µ–∫ (–æ–±—ã—á–Ω–æ –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ)</li>
            <li>–∫–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ</li>
            <li>–æ–±–Ω–æ–≤–ª—è–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª–∏</li>
        </ul>
    </li>
    <li>–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ</li>
</ol>
<p>üìå –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ –ø—Ä–∏—á–∏–Ω, –ø–æ—á–µ–º—É Go <b>–±–µ–∑–æ–ø–∞—Å–µ–Ω</b> –∏ —É–¥–æ–±–µ–Ω –¥–ª—è –±–æ–ª—å—à–æ–≥–æ —á–∏—Å–ª–∞ –≥–æ—Ä—É—Ç–∏–Ω.</p>
<hr>

<h4>3. Stack frames (–∫–∞–¥—Ä—ã —Å—Ç–µ–∫–∞)</h4>
<p>–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç <b>stack frame</b>, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö—Ä–∞–Ω—è—Ç—Å—è:</p>
<ul>
    <li>–∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏</li>
    <li>–ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</li>
    <li>return address</li>
</ul>
<pre><code class="language-go">func foo() {
    x := 10
    bar(x)
}

func bar(y int) {
    z := y + 1
    fmt.Println(z)
}</code></pre>
<p>–°—Ç–µ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):</p>
<pre><code class="language-go">bar frame:
  y
  z
foo frame:
  x</code></pre>
<hr>

<h3>Escape analysis ‚Äî –∫–ª—é—á–µ–≤–∞—è —Å–≤—è–∑—å —Å–æ stack</h3>
<p>
    –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä Go —Ä–µ—à–∞–µ—Ç:<br>
    üëâ –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ stack, –∏–ª–∏ <b>–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ ‚Äú—É–±–µ–∂–∞—Ç—å‚Äù (escape) –≤ heap</b>.
</p>
<p>–ü—Ä–∏–º–µ—Ä: –æ—Å—Ç–∞–µ—Ç—Å—è –≤ stack:</p>
<pre><code class="language-go">func sum() int {
    x := 10
    return x
}</code></pre>
<p>–ü—Ä–∏–º–µ—Ä: —É—Ö–æ–¥–∏—Ç –≤ heap:</p>
<pre><code class="language-go">func makePtr() *int {
    x := 10
    return &x // x –∂–∏–≤—ë—Ç –¥–æ–ª—å—à–µ —Ñ—É–Ω–∫—Ü–∏–∏
}</code></pre>
<p>üí• <code>x</code> <b>escape‚Äô–∏—Ç—Å—è –≤ heap</b>, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Å—ã–ª–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞—Ä—É–∂—É.</p>
<p>–ü—Ä–æ–≤–µ—Ä–∫–∞:</p>
<pre><code class="language-go">go build -gcflags="-m"</code></pre>
<hr>
<h3>Stack –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
<p>–ü–æ—á–µ–º—É stack —Ç–∞–∫ –≤–∞–∂–µ–Ω:</p>
<ul>
    <li>üî• allocation –ø–æ—á—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–∞</li>
    <li>üî• –Ω–µ—Ç GC-–ø–∞—É–∑</li>
    <li>üî• –ª—É—á—à–µ cache locality</li>
</ul>
<p>–ü—Ä–∏–º–µ—Ä –ø–ª–æ—Ö–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:</p>
<pre><code class="language-go">func bad() *MyStruct {
    s := MyStruct{}
    return &s
}</code></pre>
<p>–õ—É—á—à–µ:</p>
<pre><code class="language-go">func good() MyStruct {
    return MyStruct{}
}</code></pre>
<hr>

<h3>Stack –∏ —Ä–µ–∫—É—Ä—Å–∏—è</h3>
<p>–î–∞, <b>—Ä–µ–∫—É—Ä—Å–∏—è –≤ Go –±–µ–∑–æ–ø–∞—Å–Ω–∞</b>, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç–µ–∫ —Ä–∞—Å—Ç—ë—Ç.</p>
<p>–ù–æ ‚ö†Ô∏è:</p>
<ul>
    <li>–∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ = –Ω–æ–≤—ã–π stack frame</li>
    <li>–±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ —É–±—å—ë—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É (OOM)</li>
</ul>

<h3>–ö—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç</h3>
<ul>
    <li>–£ –∫–∞–∂–¥–æ–π –≥–æ—Ä—É—Ç–∏–Ω—ã —Å–≤–æ–π —Å—Ç–µ–∫</li>
    <li>–°—Ç–µ–∫ –º–∞–ª–µ–Ω—å–∫–∏–π –∏ <b>—Ä–∞—Å—Ç—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏</b></li>
    <li>Stack –±—ã—Å—Ç—Ä–µ–µ heap –∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ GC</li>
    <li>Escape analysis —Ä–µ—à–∞–µ—Ç: stack –∏–ª–∏ heap</li>
    <li>–í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ = heap</li>
    <li>Go –∏–∑–±–µ–≥–∞–µ—Ç stack overflow, –Ω–æ –Ω–µ OOM</li>
</ul>


<h2 id="heap">–ö—É—á–∞</h2>
<h3>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3>
<p>–ö—É—á–∞ (<b>heap</b>) –≤ Go ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, –≥–¥–µ –∂–∏–≤—É—Ç –¥–∞–Ω–Ω—ã–µ, <b>–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç–µ–∫—É—â–µ–π
    —Ñ—É–Ω–∫—Ü–∏–∏</b>.
    –î–ª—è Go-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–∞–∂–Ω–æ –Ω–µ ¬´–≥–¥–µ –ª–µ–∂–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è¬ª, –∞ <b>–∫–∞–∫ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —Ä–µ—à–∏—Ç –µ—ë —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å</b>.</p>
<hr>
<h3>–ß—Ç–æ —Ç–∞–∫–æ–µ heap</h3>
<p><b>Heap</b> ‚Äî —ç—Ç–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å, —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è <b>—Å–±–æ—Ä—â–∏–∫–æ–º –º—É—Å–æ—Ä–∞ (GC)</b>.
    –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–µ–∫–∞:</p>
<table>
    <thead>
    <tr>
        <th>–°—Ç–µ–∫</th>
        <th>–ö—É—á–∞</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>–ñ–∏–≤—ë—Ç –≤ —Ä–∞–º–∫–∞—Ö –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏</td>
        <td>–ñ–∏–≤—ë—Ç —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</td>
    </tr>
    <tr>
        <td>–ë—ã—Å—Ç—Ä—ã–π (push/pop)</td>
        <td>–ú–µ–¥–ª–µ–Ω–Ω–µ–µ</td>
    </tr>
    <tr>
        <td>–ù–µ —Ç—Ä–µ–±—É–µ—Ç GC</td>
        <td>–¢—Ä–µ–±—É–µ—Ç GC</td>
    </tr>
    </tbody>
</table>
<blockquote class="note"><b>Go –Ω–µ –¥–∞—ë—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å stack/heap –Ω–∞–ø—Ä—è–º—É—é. –†–µ—à–∞–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä.</b></blockquote>
<p>–ö–ª—é—á–µ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º ‚Äî <b>escape analysis</b>.</p>
<hr>
<h3>–ü–æ—á–µ–º—É —É–∫–∞–∑–∞—Ç–µ–ª–∏ ‚â† heap (–≤–∞–∂–Ω–æ!)</h3>
<p>‚ùå –ú–∏—Ñ: ¬´–µ—Å–ª–∏ –µ—Å—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å ‚Äî –∑–Ω–∞—á–∏—Ç heap¬ª<br>
    ‚úÖ –ü—Ä–∞–≤–¥–∞: ¬´–µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —É–±–µ–≥–∞–µ—Ç ‚Äî heap¬ª
</p>
<pre><code class="language-go">func foo() {
    x := 10
    p := &x // —É–∫–∞–∑–∞—Ç–µ–ª—å
    fmt.Println(*p)
}</code></pre>
<p>–ó–¥–µ—Å—å <code>x</code> <b>–º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Å—Ç–µ–∫–µ</b>, –ø–æ—Ç–æ–º—É —á—Ç–æ <code>p</code> –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ñ—É–Ω–∫—Ü–∏–∏.</p>
<hr>

<h3>–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –≤ heap</h3>
<h4>1. –í–æ–∑–≤—Ä–∞—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è</h4>
<pre><code class="language-go">func NewUser() *User {
    u := User{}
    return &u // heap
}</code></pre>
<h4>2. –ó–∞—Ö–≤–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–æ–π</h4>
<pre><code class="language-go">func start() {
    x := 42
    go func() {
        fmt.Println(x) // x ‚Üí heap
    }()
}</code></pre>
<h4>3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ interface{}</h4>
<pre><code class="language-go">func log(v interface{}) {
    fmt.Println(v)
}

func main() {
    x := 10
    log(x) // —á–∞—Å—Ç–æ heap
}</code></pre>
<p>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã ‚Üí —É–ø–∞–∫–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã–π escape.</p>
<h4>4. –ë–æ–ª—å—à–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</h4>
<p>–ò–Ω–æ–≥–¥–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä <b>—Å–∞–º —Ä–µ—à–∞–µ—Ç</b> –ø–æ–ª–æ–∂–∏—Ç—å –æ–±—ä–µ–∫—Ç –≤ heap –∏–∑-–∑–∞ —Ä–∞–∑–º–µ—Ä–∞.</p>
<hr>


<h3>Heap –∏ GC</h3>
<p>–í—Å—ë, —á—Ç–æ –ª–µ–∂–∏—Ç –≤ –∫—É—á–µ:</p>
<ul>
    <li>–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è <b>—Å–±–æ—Ä—â–∏–∫–æ–º –º—É—Å–æ—Ä–∞</b></li>
    <li>—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç:
        <ul>
            <li>–≤—Ä–µ–º—è –ø–∞—É–∑</li>
            <li>–Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ CPU</li>
            <li>–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏</li>
        </ul>
    </li>
</ul>
<p>üìå <b>–ß–µ–º –º–µ–Ω—å—à–µ heap-–∞–ª–ª–æ–∫–∞—Ü–∏–π ‚Äî —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞</b></p>

<h3>–ö–∞–∫ —É–º–µ–Ω—å—à–∞—Ç—å heap-–∞–ª–ª–æ–∫–∞—Ü–∏–∏</h3>
<ul>
    <li>
        ‚úî –í–æ–∑–≤—Ä–∞—â–∞–π –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏
        <pre><code class="language-go">func NewUser() User</code></pre>
    </li>
    <li>
        ‚úî –ò—Å–ø–æ–ª—å–∑—É–π sync.Pool –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        <pre><code class="language-go">var pool = sync.Pool{
    New: func() any {
        return new(bytes.Buffer)
    },
}</code></pre>
    </li>
    <li>‚úî –ò–∑–±–µ–≥–∞–π interface{} –≤ –≥–æ—Ä—è—á–∏—Ö –º–µ—Å—Ç–∞—Ö</li>
    <li>‚úî –ü–µ—Ä–µ–¥–∞–≤–∞–π —Å–ª–∞–π—Å—ã, –∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–µ</li>
</ul>

<h2>Stack vs Heap –≤ Go</h2>
<h3>–í–∞–∂–Ω–æ–µ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ <code>x := new(int)</code> –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–µ—Ç–∏—Ç –≤ <b>heap</b>, –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ –≤ <b>stack</b>!</h3>
<p>–ß—Ç–æ <code></code></p>
<table>
    <thead>
    <tr>
        <th>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
        <th>Stack</th>
        <th>Heap</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>–°–∫–æ—Ä–æ—Å—Ç—å</td>
        <td>–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è</td>
        <td>–ú–µ–¥–ª–µ–Ω–Ω–µ–µ</td>
    </tr>
    <tr>
        <td>GC</td>
        <td>‚ùå –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç</td>
        <td>‚úÖ —É—á–∞—Å—Ç–≤—É–µ—Ç</td>
    </tr>
    <tr>
        <td>–í—Ä–µ–º—è –∂–∏–∑–Ω–∏</td>
        <td>–ü–æ–∫–∞ —Ñ—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞</td>
        <td>–ü–æ–∫–∞ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏</td>
    </tr>
    <tr>
        <td>–ü—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å</td>
        <td>–ì–æ—Ä—É—Ç–∏–Ω–∞</td>
        <td>–í—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</td>
    </tr>
    </tbody>
</table>
<p>üìå –ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:</p>
<blockquote class="note">–í—Å—ë, —á—Ç–æ –º–æ–∂–µ—Ç –∂–∏—Ç—å –≤ stack ‚Äî –±—É–¥–µ—Ç –∂–∏—Ç—å –≤ stack.</blockquote>

{{ end }}