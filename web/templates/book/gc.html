{{ define "book.gc" }}
<h1>–°–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞ (Garbage collector)</h1>
<p>–≠—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤, <b>–Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–∏–º—ã—Ö
    —Å—Å—ã–ª–æ–∫</b>.</p>
<p>–í Go –æ–Ω:</p>
<ul>
    <li><b>–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π</b></li>
    <li><b>—Ç—Ä–∏-—Ü–≤–µ—Ç–Ω—ã–π</b></li>
    <li><b>mark-and-sweep</b></li>
    <li><b>–Ω–∏–∑–∫–æ–ª–∞—Ç–µ–Ω—Ç–Ω—ã–π</b></li>
    <li>–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ <b>–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ stop-the-world (STW)</b></li>
</ul>
<hr>
<h2>üß± –ì–¥–µ –∂–∏–≤—ë—Ç –ø–∞–º—è—Ç—å</h2>
<p>–í Go –ø–∞–º—è—Ç—å –¥–µ–ª–∏—Ç—Å—è –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–∞:</p>
<ul>
    <li><b>Stack</b> ‚Äî –ø–∞–º—è—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—ã
        <ul>
            <li>—Ä–∞—Å—Ç—ë—Ç –∏ —Å–∂–∏–º–∞–µ—Ç—Å—è</li>
            <li>–Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è GC</li>
        </ul>
    </li>
    <li><b>Heap</b> ‚Äî –æ–±—â–∞—è –∫—É—á–∞
        <ul>
            <li>–æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–µ—Ä–µ–∂–∏—Ç—å <i>—Ñ—É–Ω–∫—Ü–∏—é</i></li>
            <li>—É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è GC</li>
        </ul>
    </li>
</ul>
<p>üìå –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:</p>
<blockquote class="note"><b>GC —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û —Å –∫—É—á–µ–π</b></blockquote>

<hr>
<h2>üß™ Escape analysis (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è GC)</h2>
<p>–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä Go –∑–∞—Ä–∞–Ω–µ–µ —Ä–µ—à–∞–µ—Ç, –≥–¥–µ –≤—ã–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å:</p>
<pre><code class="language-go">func f() *int {
    x := 10
    return &x // x —É–±–µ–∂–∞–ª –≤ heap
}</code></pre>
<pre><code class="language-go">func f() int {
    x := 10
    return x // stack
}</code></pre>
<p>–ß–µ–º <b>–º–µ–Ω—å—à–µ heap-–æ–±—ä–µ–∫—Ç–æ–≤</b>, —Ç–µ–º:</p>
<ul>
    <li>–º–µ–Ω—å—à–µ —Ä–∞–±–æ—Ç—ã —É GC</li>
    <li>–Ω–∏–∂–µ –ø–∞—É–∑—ã</li>
    <li>–≤—ã—à–µ throughput</li>
</ul>
<p>üîß –ü—Ä–æ–≤–µ—Ä–∫–∞:</p>
<pre><code class="language-go">go build -gcflags="-m"</code></pre>

<hr>
<h2>üé® –¢—Ä—ë—Ö—Ü–≤–µ—Ç–Ω–∞—è –º–æ–¥–µ–ª—å</h2>
<p>GC –ø–æ–º–µ—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã —Ü–≤–µ—Ç–∞–º–∏:</p>
<table>
    <thead>
    <tr>
        <th>–¶–≤–µ—Ç</th>
        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>–ë–µ–ª—ã–π</td>
        <td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –º—É—Å–æ—Ä</td>
    </tr>
    <tr>
        <td>–°–µ—Ä—ã–π</td>
        <td>–î–æ—Å—Ç–∏–∂–∏–º, –Ω–æ —Å—Å—ã–ª–∫–∏ –Ω–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã</td>
    </tr>
    <tr>
        <td>–ß—ë—Ä–Ω—ã–π</td>
        <td>–î–æ—Å—Ç–∏–∂–∏–º, —Å—Å—ã–ª–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã</td>
    </tr>
    </tbody>
</table>

<p>–ê–ª–≥–æ—Ä–∏—Ç–º:</p>
<ol>
    <li><b>STW (–∫–æ—Ä–æ—Ç–∫–∏–π)</b> ‚Äî –≤—Å–µ –∫–æ—Ä–Ω–∏ ‚Üí —Å–µ—Ä—ã–µ</li>
    <li><b>Concurrent mark</b> ‚Äî —Å–µ—Ä—ã–µ ‚Üí —á—ë—Ä–Ω—ã–µ</li>
    <li><b>Sweep</b> ‚Äî –±–µ–ª—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è</li>
</ol>

<hr>
<h2>‚è∏ Stop-the-World (STW)</h2>
<p>–í Go STW –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π:</p>
<ul>
    <li>–¥–µ—Å—è—Ç–∫–∏ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥</li>
    <li>—Ç–æ–ª—å–∫–æ –¥–ª—è:
        <ul>
            <li>–Ω–∞—á–∞–ª–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏</li>
            <li>—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏</li>
        </ul>
    </li>
</ul>
<p>‚ùó –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî <b>–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π</b></p>


<hr>
<h2>üîÅ Write Barrier (–∫–ª—é—á –∫ concurrency)</h2>
<p>–ü—Ä–æ–±–ª–µ–º–∞:</p>
<blockquote class="note">—á—Ç–æ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <b>–º–µ–Ω—è–µ—Ç —Å—Å—ã–ª–∫–∏</b>, –ø–æ–∫–∞ GC –º–∞—Ä–∫–∏—Ä—É–µ—Ç?</blockquote>
<pre><code class="language-go">a.child = b</code></pre>
<p>–ï—Å–ª–∏ <b>a</b> —É–∂–µ —á—ë—Ä–Ω—ã–π, –∞ <b>b</b> –±–µ–ª—ã–π ‚Üí <b>b</b> —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä—ã–º.</p>
<p>üìå –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç:</p>
<blockquote class="note">—á—ë—Ä–Ω—ã–π –Ω–µ –º–æ–∂–µ—Ç —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –±–µ–ª—ã–π</blockquote>

<hr>
<h2>‚öôÔ∏è –ü–æ–∫–æ–ª–µ–Ω–∏–π –Ω–µ—Ç (–ø–æ—á—Ç–∏)</h2>
<p>–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç JVM:</p>
<ul>
    <li>‚ùå –Ω–µ—Ç generational GC</li>
    <li>‚ùå –Ω–µ—Ç young/old heap</li>
</ul>
<p>–ü–æ—á–µ–º—É?</p>
<ul>
    <li>—Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ</li>
    <li>Go –¥–µ–ª–∞–µ—Ç —Å—Ç–∞–≤–∫—É –Ω–∞:
        <ul>
            <li>–±—ã—Å—Ç—Ä—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏</li>
            <li>–¥–µ—à—ë–≤—É—é –æ—á–∏—Å—Ç–∫—É</li>
            <li>–∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–µ –æ–±—ä–µ–∫—Ç—ã</li>
        </ul>
    </li>
</ul>
<p>‚ö†Ô∏è –ï—Å—Ç—å <b>pacing</b> –∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ ‚Äî <i>—á–∞—Å—Ç–∏—á–Ω–æ</i> –ø–æ—Ö–æ–∂–∏, –Ω–æ –Ω–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è.</p>

<hr>
<h2>üìè –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è GC</h2>
<p>–û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî <b>GOGC</b></p>
<pre><code class="language-go">GOGC=100</code></pre>
<p>–û–∑–Ω–∞—á–∞–µ—Ç:</p>
<blockquote class="note">GC –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –∫–æ–≥–¥–∞ heap –≤—ã—Ä–∞—Å—Ç–µ—Ç –Ω–∞ <b>100% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å–ª–µ –ø—Ä–æ—à–ª–æ–≥–æ GC</b></blockquote>
<table>
    <thead>
    <tr>
        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
        <th>–≠—Ñ—Ñ–µ–∫—Ç</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td><code>GOGC=50</code></td>
        <td>—á–∞—â–µ GC, –º–µ–Ω—å—à–µ heap</td>
    </tr>
    <tr>
        <td><code>GOGC=200</code></td>
        <td>—Ä–µ–∂–µ GC, –±–æ–ª—å—à–µ heap</td>
    </tr>
    <tr>
        <td><code>GOGC=off</code></td>
        <td>‚ùå –æ–ø–∞—Å–Ω–æ</td>
    </tr>
    </tbody>
</table>


<hr>
<h2>üìä –ú–µ—Ç—Ä–∏–∫–∏ GC</h2>
<pre><code class="language-go">import "runtime"

var m runtime.MemStats
runtime.ReadMemStats(&m)</code></pre>
<p>–ü–æ–ª–µ–∑–Ω–æ–µ:</p>
<ul>
    <li>HeapAlloc</li>
    <li>HeapObjects</li>
    <li>NumGC</li>
    <li>PauseNs</li>
</ul>

<hr>
<h2>üß® –¢–∏–ø–∏—á–Ω—ã–µ GC-–ø—Ä–æ–±–ª–µ–º—ã –≤ Go</h2>
<p>1Ô∏è‚É£ –õ–∏—à–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏</p>
<pre><code class="language-go">fmt.Sprintf(...) // –≤—Å–µ–≥–¥–∞ heap</code></pre>
<p>2Ô∏è‚É£ –ë–æ–ª—å—à–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</p>
<pre><code class="language-go">buf := make([]byte, 10<<20)</code></pre>
<p>3Ô∏è‚É£ interface{} –∏ boxing</p>
<pre><code class="language-go">var x interface{} = 10</code></pre>
<p>4Ô∏è‚É£ –ó–∞—Ö–≤–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–º—ã–∫–∞–Ω–∏—è–º–∏</p>
<pre><code class="language-go">go func() {
    fmt.Println(bigStruct)
}()</code></pre>


<hr>
<h2>üß† –ö–∞–∫ –ø–∏—Å–∞—Ç—å GC-friendly –∫–æ–¥</h2>
<ul>
    <li>‚úî –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π heap</li>
    <li>‚úî –ò—Å–ø–æ–ª—å–∑—É–π sync.Pool –¥–ª—è hot-path</li>
    <li>‚úî –ü—Ä–µ–¥–∞–ª–ª–æ—Ü–∏—Ä—É–π —Å—Ä–µ–∑—ã</li>
    <li>‚úî –ò–∑–±–µ–≥–∞–π –ª–∏—à–Ω–∏—Ö fmt</li>
    <li>‚úî –°–ª–µ–¥–∏ –∑–∞ escape analysis</li>
    <li>‚úî –ò—Å–ø–æ–ª—å–∑—É–π pprof:</li>
</ul>
<pre><code class="language-go">go test -bench . -memprofile mem.out</code></pre>

<hr>
<h2>üß© –°–≤—è–∑—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º</h2>
<ul>
    <li>GC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ P</li>
    <li>–í–æ –≤—Ä–µ–º—è GC —á–∞—Å—Ç—å CPU –∑–∞–±–∏—Ä–∞–µ—Ç—Å—è —É user-goroutines</li>
    <li>–í—ã—Å–æ–∫–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è ‚áí –±–æ–ª—å—à–µ GC ‚áí –º–µ–Ω—å—à–µ throughput</li>
</ul>

{{ end }}