import{A as e,D as t,F as n,I as r,M as i,N as a,P as o,T as s,h as c,l}from"./index-CIkfNzNJ.js";var u=l(`circle-pause`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`line`,{x1:`10`,x2:`10`,y1:`15`,y2:`9`,key:`c1nkhi`}],[`line`,{x1:`14`,x2:`14`,y1:`15`,y2:`9`,key:`h65svq`}]]),d=l(`circle-play`,[[`path`,{d:`M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z`,key:`kmsa83`}],[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}]]),f=l(`circle-stop`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`rect`,{x:`9`,y:`9`,width:`6`,height:`6`,rx:`1`,key:`1ssd4o`}]]),p={container:`_container_55uwz_1`},m=i(),h=c(),g=`.mid,.midi,audio/midi,audio/x-midi`;const _=({onMidiLoaded:n,disabled:r})=>{let{message:i}=e.useApp(),a=(0,m.useRef)(null);return(0,h.jsxs)(`div`,{style:{display:`flex`,gap:8,alignItems:`center`},children:[(0,h.jsx)(`input`,{ref:a,type:`file`,accept:g,onChange:async e=>{let t=e.target.files?.[0];if(!t)return;let r=t.name.toLowerCase();if(!r.endsWith(`.mid`)&&!r.endsWith(`.midi`)){i.warning(`Похоже, это не MIDI файл (.mid/.midi).`),e.target.value=``;return}n({file:t,arrayBuffer:await t.arrayBuffer()}),e.target.value=``},style:{display:`none`}}),(0,h.jsx)(t,{type:`primary`,onClick:()=>{a.current?.click()},disabled:r,children:`Загрузить MIDI`}),(0,h.jsx)(`span`,{style:{opacity:.7,fontSize:12},children:`.mid / .midi`})]})};var v=a(((e,t)=>{function n(e){var t=new a(e),n=t.readChunk();if(n.id!=`MThd`)throw`Bad MIDI file.  Expected 'MHdr', got: '`+n.id+`'`;for(var o=r(n.data),s=[],c=0;!t.eof()&&c<o.numTracks;c++){var l=t.readChunk();if(l.id!=`MTrk`)throw`Bad MIDI file.  Expected 'MTrk', got: '`+l.id+`'`;var u=i(l.data);s.push(u)}return{header:o,tracks:s}}function r(e){var t=new a(e),n={format:t.readUInt16(),numTracks:t.readUInt16()},r=t.readUInt16();return r&32768?(n.framesPerSecond=256-(r>>8),n.ticksPerFrame=r&255):n.ticksPerBeat=r,n}function i(e){for(var t=new a(e),n=[];!t.eof();){var r=i();n.push(r)}return n;function i(){var e={};e.deltaTime=t.readVarInt();var n=t.readUInt8();if((n&240)==240)if(n===255){e.meta=!0;var r=t.readUInt8(),i=t.readVarInt();switch(r){case 0:if(e.type=`sequenceNumber`,i!==2)throw`Expected length for sequenceNumber event is 2, got `+i;return e.number=t.readUInt16(),e;case 1:return e.type=`text`,e.text=t.readString(i),e;case 2:return e.type=`copyrightNotice`,e.text=t.readString(i),e;case 3:return e.type=`trackName`,e.text=t.readString(i),e;case 4:return e.type=`instrumentName`,e.text=t.readString(i),e;case 5:return e.type=`lyrics`,e.text=t.readString(i),e;case 6:return e.type=`marker`,e.text=t.readString(i),e;case 7:return e.type=`cuePoint`,e.text=t.readString(i),e;case 32:if(e.type=`channelPrefix`,i!=1)throw`Expected length for channelPrefix event is 1, got `+i;return e.channel=t.readUInt8(),e;case 33:if(e.type=`portPrefix`,i!=1)throw`Expected length for portPrefix event is 1, got `+i;return e.port=t.readUInt8(),e;case 47:if(e.type=`endOfTrack`,i!=0)throw`Expected length for endOfTrack event is 0, got `+i;return e;case 81:if(e.type=`setTempo`,i!=3)throw`Expected length for setTempo event is 3, got `+i;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type=`smpteOffset`,i!=5)throw`Expected length for smpteOffset event is 5, got `+i;var a=t.readUInt8();return e.frameRate={0:24,32:25,64:29,96:30}[a&96],e.hour=a&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type=`timeSignature`,i!=2&&i!=4)throw`Expected length for timeSignature event is 4 or 2, got `+i;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),i===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type=`keySignature`,i!=2)throw`Expected length for keySignature event is 2, got `+i;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type=`sequencerSpecific`,e.data=t.readBytes(i),e;default:return e.type=`unknownMeta`,e.data=t.readBytes(i),e.metatypeByte=r,e}}else if(n==240){e.type=`sysEx`;var i=t.readVarInt();return e.data=t.readBytes(i),e}else if(n==247){e.type=`endSysEx`;var i=t.readVarInt();return e.data=t.readBytes(i),e}else throw`Unrecognised MIDI event type byte: `+n;else{var s;if(n&128)s=t.readUInt8(),o=n;else{if(o===null)throw`Running status byte encountered before status byte`;s=n,n=o,e.running=!0}var c=n>>4;switch(e.channel=n&15,c){case 8:return e.type=`noteOff`,e.noteNumber=s,e.velocity=t.readUInt8(),e;case 9:var l=t.readUInt8();return e.type=l===0?`noteOff`:`noteOn`,e.noteNumber=s,e.velocity=l,l===0&&(e.byte9=!0),e;case 10:return e.type=`noteAftertouch`,e.noteNumber=s,e.amount=t.readUInt8(),e;case 11:return e.type=`controller`,e.controllerType=s,e.value=t.readUInt8(),e;case 12:return e.type=`programChange`,e.programNumber=s,e;case 13:return e.type=`channelAftertouch`,e.amount=s,e;case 14:return e.type=`pitchBend`,e.value=s+(t.readUInt8()<<7)-8192,e;default:throw`Unrecognised MIDI event type: `+c}}}var o}function a(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}a.prototype.eof=function(){return this.pos>=this.bufferLen},a.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},a.prototype.readInt8=function(){var e=this.readUInt8();return e&128?e-256:e},a.prototype.readUInt16=function(){var e=this.readUInt8(),t=this.readUInt8();return(e<<8)+t},a.prototype.readInt16=function(){var e=this.readUInt16();return e&32768?e-65536:e},a.prototype.readUInt24=function(){var e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8();return(e<<16)+(t<<8)+n},a.prototype.readInt24=function(){var e=this.readUInt24();return e&8388608?e-16777216:e},a.prototype.readUInt32=function(){var e=this.readUInt8(),t=this.readUInt8(),n=this.readUInt8(),r=this.readUInt8();return(e<<24)+(t<<16)+(n<<8)+r},a.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},a.prototype.readString=function(e){var t=this.readBytes(e);return String.fromCharCode.apply(null,t)},a.prototype.readVarInt=function(){for(var e=0;!this.eof();){var t=this.readUInt8();if(t&128)e+=t&127,e<<=7;else return e+t}return e},a.prototype.readChunk=function(){var e=this.readString(4),t=this.readUInt32();return{id:e,length:t,data:this.readBytes(t)}},t.exports=n})),y=a(((e,t)=>{function n(e,t){if(typeof e!=`object`)throw`Invalid MIDI data`;t||={};var n=e.header||{},a=e.tracks||[],s,c=a.length,l=new o;for(r(l,n,c),s=0;s<c;s++)i(l,a[s],t);return l.buffer}function r(e,t,n){var r=t.format==null?1:t.format,i=128;t.timeDivision?i=t.timeDivision:t.ticksPerFrame&&t.framesPerSecond?i=-(t.framesPerSecond&255)<<8|t.ticksPerFrame&255:t.ticksPerBeat&&(i=t.ticksPerBeat&32767);var a=new o;a.writeUInt16(r),a.writeUInt16(n),a.writeUInt16(i),e.writeChunk(`MThd`,a.buffer)}function i(e,t,n){var r=new o,i,s=t.length,c=null;for(i=0;i<s;i++)(n.running===!1||!n.running&&!t[i].running)&&(c=null),c=a(r,t[i],c,n.useByte9ForNoteOff);e.writeChunk(`MTrk`,r.buffer)}function a(e,t,n,r){var i=t.type,a=t.deltaTime,o=t.text||``,s=t.data||[],c=null;switch(e.writeVarInt(a),i){case`sequenceNumber`:e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case`text`:e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(o.length),e.writeString(o);break;case`copyrightNotice`:e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(o.length),e.writeString(o);break;case`trackName`:e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(o.length),e.writeString(o);break;case`instrumentName`:e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(o.length),e.writeString(o);break;case`lyrics`:e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(o.length),e.writeString(o);break;case`marker`:e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(o.length),e.writeString(o);break;case`cuePoint`:e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(o.length),e.writeString(o);break;case`channelPrefix`:e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case`portPrefix`:e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case`endOfTrack`:e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case`setTempo`:e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case`smpteOffset`:e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var l=t.hour&31|{24:0,25:32,29:64,30:96}[t.frameRate];e.writeUInt8(l),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case`timeSignature`:e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var u=Math.floor(Math.log(t.denominator)/Math.LN2)&255;e.writeUInt8(u),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case`keySignature`:e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case`sequencerSpecific`:e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(s.length),e.writeBytes(s);break;case`unknownMeta`:t.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(s.length),e.writeBytes(s));break;case`sysEx`:e.writeUInt8(240),e.writeVarInt(s.length),e.writeBytes(s);break;case`endSysEx`:e.writeUInt8(247),e.writeVarInt(s.length),e.writeBytes(s);break;case`noteOff`:c=(r!==!1&&t.byte9||r&&t.velocity==0?144:128)|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case`noteOn`:c=144|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case`noteAftertouch`:c=160|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case`controller`:c=176|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case`programChange`:c=192|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.programNumber);break;case`channelAftertouch`:c=208|t.channel,c!==n&&e.writeUInt8(c),e.writeUInt8(t.amount);break;case`pitchBend`:c=224|t.channel,c!==n&&e.writeUInt8(c);var d=8192+t.value,f=d&127,p=d>>7&127;e.writeUInt8(f),e.writeUInt8(p);break;default:throw`Unrecognized event type: `+i}return c}function o(){this.buffer=[]}o.prototype.writeUInt8=function(e){this.buffer.push(e&255)},o.prototype.writeInt8=o.prototype.writeUInt8,o.prototype.writeUInt16=function(e){var t=e>>8&255,n=e&255;this.writeUInt8(t),this.writeUInt8(n)},o.prototype.writeInt16=o.prototype.writeUInt16,o.prototype.writeUInt24=function(e){var t=e>>16&255,n=e>>8&255,r=e&255;this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(r)},o.prototype.writeInt24=o.prototype.writeUInt24,o.prototype.writeUInt32=function(e){var t=e>>24&255,n=e>>16&255,r=e>>8&255,i=e&255;this.writeUInt8(t),this.writeUInt8(n),this.writeUInt8(r),this.writeUInt8(i)},o.prototype.writeInt32=o.prototype.writeUInt32,o.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},o.prototype.writeString=function(e){var t,n=e.length,r=[];for(t=0;t<n;t++)r.push(e.codePointAt(t));this.writeBytes(r)},o.prototype.writeVarInt=function(e){if(e<0)throw`Cannot write negative variable-length integer`;if(e<=127)this.writeUInt8(e);else{var t=e,n=[];for(n.push(t&127),t>>=7;t;){var r=t&127|128;n.push(r),t>>=7}this.writeBytes(n.reverse())}},o.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},t.exports=n})),b=a((e=>{e.parseMidi=v(),e.writeMidi=y()})),x=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.insert=e.search=void 0;function t(e,t,n){n===void 0&&(n=`ticks`);var r=0,i=e.length,a=i;if(i>0&&e[i-1][n]<=t)return i-1;for(;r<a;){var o=Math.floor(r+(a-r)/2),s=e[o],c=e[o+1];if(s[n]===t){for(var l=o;l<e.length;l++)e[l][n]===t&&(o=l);return o}else if(s[n]<t&&c[n]>t)return o;else s[n]>t?a=o:s[n]<t&&(r=o+1)}return-1}e.search=t;function n(e,n,r){if(r===void 0&&(r=`ticks`),e.length){var i=t(e,n[r],r);e.splice(i+1,0,n)}else e.push(n)}e.insert=n})),S=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.Header=e.keySignatureKeys=void 0;var t=x(),n=new WeakMap;e.keySignatureKeys=[`Cb`,`Gb`,`Db`,`Ab`,`Eb`,`Bb`,`F`,`C`,`G`,`D`,`A`,`E`,`B`,`F#`,`C#`],e.Header=function(){function r(t){var r=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name=``,n.set(this,480),t){n.set(this,t.header.ticksPerBeat),t.tracks.forEach(function(t){t.forEach(function(t){t.meta&&(t.type===`timeSignature`?r.timeSignatures.push({ticks:t.absoluteTime,timeSignature:[t.numerator,t.denominator]}):t.type===`setTempo`?r.tempos.push({bpm:6e7/t.microsecondsPerBeat,ticks:t.absoluteTime}):t.type===`keySignature`&&r.keySignatures.push({key:e.keySignatureKeys[t.key+7],scale:t.scale===0?`major`:`minor`,ticks:t.absoluteTime}))})});var i=0;t.tracks[0].forEach(function(e){i+=e.deltaTime,e.meta&&(e.type===`trackName`?r.name=e.text:(e.type===`text`||e.type===`cuePoint`||e.type===`marker`||e.type===`lyrics`)&&r.meta.push({text:e.text,ticks:i,type:e.type}))}),this.update()}}return r.prototype.update=function(){var e=this,t=0,n=0;this.tempos.sort(function(e,t){return e.ticks-t.ticks}),this.tempos.forEach(function(r,i){var a=i>0?e.tempos[i-1].bpm:e.tempos[0].bpm,o=r.ticks/e.ppq-n;r.time=60/a*o+t,t=r.time,n+=o}),this.timeSignatures.sort(function(e,t){return e.ticks-t.ticks}),this.timeSignatures.forEach(function(t,n){var r=n>0?e.timeSignatures[n-1]:e.timeSignatures[0],i=(t.ticks-r.ticks)/e.ppq/r.timeSignature[0]/(r.timeSignature[1]/4);r.measures=r.measures||0,t.measures=i+r.measures})},r.prototype.ticksToSeconds=function(e){var n=(0,t.search)(this.tempos,e);if(n!==-1){var r=this.tempos[n],i=r.time,a=(e-r.ticks)/this.ppq;return i+60/r.bpm*a}else return 60/120*(e/this.ppq)},r.prototype.ticksToMeasures=function(e){var n=(0,t.search)(this.timeSignatures,e);if(n!==-1){var r=this.timeSignatures[n],i=(e-r.ticks)/this.ppq;return r.measures+i/(r.timeSignature[0]/r.timeSignature[1])/4}else return e/this.ppq/4},Object.defineProperty(r.prototype,`ppq`,{get:function(){return n.get(this)},enumerable:!1,configurable:!0}),r.prototype.secondsToTicks=function(e){var n=(0,t.search)(this.tempos,e,`time`);if(n!==-1){var r=this.tempos[n],i=(e-r.time)/(60/r.bpm);return Math.round(r.ticks+i*this.ppq)}else{var a=e/(60/120);return Math.round(a*this.ppq)}},r.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(e){return{bpm:e.bpm,ticks:e.ticks}}),timeSignatures:this.timeSignatures}},r.prototype.fromJSON=function(e){this.name=e.name,this.tempos=e.tempos.map(function(e){return Object.assign({},e)}),this.timeSignatures=e.timeSignatures.map(function(e){return Object.assign({},e)}),this.keySignatures=e.keySignatures.map(function(e){return Object.assign({},e)}),this.meta=e.meta.map(function(e){return Object.assign({},e)}),n.set(this,e.ppq),this.update()},r.prototype.setTempo=function(e){this.tempos=[{bpm:e,ticks:0}],this.update()},r}()})),C=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:`modulationWheel`,2:`breath`,4:`footController`,5:`portamentoTime`,7:`volume`,8:`balance`,10:`pan`,64:`sustain`,65:`portamentoTime`,66:`sostenuto`,67:`softPedal`,68:`legatoFootswitch`,84:`portamentoControl`},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(t,n){return t[e.controlChangeNames[n]]=n,t},{});var t=new WeakMap,n=new WeakMap;e.ControlChange=function(){function r(e,r){t.set(this,r),n.set(this,e.controllerType),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(r.prototype,`number`,{get:function(){return n.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,`name`,{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,`time`,{get:function(){return t.get(this).ticksToSeconds(this.ticks)},set:function(e){this.ticks=t.get(this).secondsToTicks(e)},enumerable:!1,configurable:!0}),r.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},r}()})),w=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.createControlChanges=void 0;var t=C();function n(){return new Proxy({},{get:function(e,n){if(e[n])return e[n];if(t.controlChangeIds.hasOwnProperty(n))return e[t.controlChangeIds[n]]},set:function(e,n,r){return t.controlChangeIds.hasOwnProperty(n)?e[t.controlChangeIds[n]]=r:e[n]=r,!0}})}e.createControlChanges=n})),T=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.PitchBend=void 0;var t=new WeakMap;e.PitchBend=function(){function e(e,n){t.set(this,n),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(e.prototype,`time`,{get:function(){return t.get(this).ticksToSeconds(this.ticks)},set:function(e){this.ticks=t.get(this).secondsToTicks(e)},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},e}()})),E=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.DrumKitByPatchID=e.InstrumentFamilyByID=e.instrumentByPatchID=void 0,e.instrumentByPatchID=`acoustic grand piano.bright acoustic piano.electric grand piano.honky-tonk piano.electric piano 1.electric piano 2.harpsichord.clavi.celesta.glockenspiel.music box.vibraphone.marimba.xylophone.tubular bells.dulcimer.drawbar organ.percussive organ.rock organ.church organ.reed organ.accordion.harmonica.tango accordion.acoustic guitar (nylon).acoustic guitar (steel).electric guitar (jazz).electric guitar (clean).electric guitar (muted).overdriven guitar.distortion guitar.guitar harmonics.acoustic bass.electric bass (finger).electric bass (pick).fretless bass.slap bass 1.slap bass 2.synth bass 1.synth bass 2.violin.viola.cello.contrabass.tremolo strings.pizzicato strings.orchestral harp.timpani.string ensemble 1.string ensemble 2.synthstrings 1.synthstrings 2.choir aahs.voice oohs.synth voice.orchestra hit.trumpet.trombone.tuba.muted trumpet.french horn.brass section.synthbrass 1.synthbrass 2.soprano sax.alto sax.tenor sax.baritone sax.oboe.english horn.bassoon.clarinet.piccolo.flute.recorder.pan flute.blown bottle.shakuhachi.whistle.ocarina.lead 1 (square).lead 2 (sawtooth).lead 3 (calliope).lead 4 (chiff).lead 5 (charang).lead 6 (voice).lead 7 (fifths).lead 8 (bass + lead).pad 1 (new age).pad 2 (warm).pad 3 (polysynth).pad 4 (choir).pad 5 (bowed).pad 6 (metallic).pad 7 (halo).pad 8 (sweep).fx 1 (rain).fx 2 (soundtrack).fx 3 (crystal).fx 4 (atmosphere).fx 5 (brightness).fx 6 (goblins).fx 7 (echoes).fx 8 (sci-fi).sitar.banjo.shamisen.koto.kalimba.bag pipe.fiddle.shanai.tinkle bell.agogo.steel drums.woodblock.taiko drum.melodic tom.synth drum.reverse cymbal.guitar fret noise.breath noise.seashore.bird tweet.telephone ring.helicopter.applause.gunshot`.split(`.`),e.InstrumentFamilyByID=[`piano`,`chromatic percussion`,`organ`,`guitar`,`bass`,`strings`,`ensemble`,`brass`,`reed`,`pipe`,`synth lead`,`synth pad`,`synth effects`,`world`,`percussive`,`sound effects`],e.DrumKitByPatchID={0:`standard kit`,8:`room kit`,16:`power kit`,24:`electronic kit`,25:`tr-808 kit`,32:`jazz kit`,40:`brush kit`,48:`orchestra kit`,56:`sound fx kit`}})),D=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.Instrument=void 0;var t=E(),n=new WeakMap;e.Instrument=function(){function e(e,t){if(this.number=0,n.set(this,t),this.number=0,e){var r=e.find(function(e){return e.type===`programChange`});r&&(this.number=r.programNumber)}}return Object.defineProperty(e.prototype,`name`,{get:function(){return this.percussion?t.DrumKitByPatchID[this.number]:t.instrumentByPatchID[this.number]},set:function(e){var n=t.instrumentByPatchID.indexOf(e);n!==-1&&(this.number=n)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`family`,{get:function(){return this.percussion?`drums`:t.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`percussion`,{get:function(){return n.get(this).channel===9},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},e.prototype.fromJSON=function(e){this.number=e.number},e}()})),O=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.Note=void 0;function t(e){var t=Math.floor(e/12)-1;return n(e)+t.toString()}function n(e){return[`C`,`C#`,`D`,`D#`,`E`,`F`,`F#`,`G`,`G#`,`A`,`A#`,`B`][e%12]}function r(e){return[`C`,`C#`,`D`,`D#`,`E`,`F`,`F#`,`G`,`G#`,`A`,`A#`,`B`].indexOf(e)}var i=function(){var e=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,t={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(n){var r=e.exec(n),i=r[1],a=r[2];return t[i.toLowerCase()]+(parseInt(a,10)+1)*12}}(),a=new WeakMap;e.Note=function(){function e(e,t,n){a.set(this,n),this.midi=e.midi,this.velocity=e.velocity,this.noteOffVelocity=t.velocity,this.ticks=e.ticks,this.durationTicks=t.ticks-e.ticks}return Object.defineProperty(e.prototype,`name`,{get:function(){return t(this.midi)},set:function(e){this.midi=i(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`octave`,{get:function(){return Math.floor(this.midi/12)-1},set:function(e){var t=e-this.octave;this.midi+=t*12},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`pitch`,{get:function(){return n(this.midi)},set:function(e){this.midi=12*(this.octave+1)+r(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`duration`,{get:function(){var e=a.get(this);return e.ticksToSeconds(this.ticks+this.durationTicks)-e.ticksToSeconds(this.ticks)},set:function(e){this.durationTicks=a.get(this).secondsToTicks(this.time+e)-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`time`,{get:function(){return a.get(this).ticksToSeconds(this.ticks)},set:function(e){this.ticks=a.get(this).secondsToTicks(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`bars`,{get:function(){return a.get(this).ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},e}()})),k=a((e=>{Object.defineProperty(e,`__esModule`,{value:!0}),e.Track=void 0;var t=x(),n=C(),r=w(),i=T(),a=D(),o=O(),s=new WeakMap;e.Track=function(){function e(e,t){var n=this;if(this.name=``,this.notes=[],this.controlChanges=(0,r.createControlChanges)(),this.pitchBends=[],s.set(this,t),e){var i=e.find(function(e){return e.type===`trackName`});this.name=i?i.text:``}if(this.instrument=new a.Instrument(e,this),this.channel=0,e){for(var o=e.filter(function(e){return e.type===`noteOn`}),c=e.filter(function(e){return e.type===`noteOff`}),l=function(){var e=o.shift();u.channel=e.channel;var t=c.findIndex(function(t){return t.noteNumber===e.noteNumber&&t.absoluteTime>=e.absoluteTime});if(t!==-1){var n=c.splice(t,1)[0];u.addNote({durationTicks:n.absoluteTime-e.absoluteTime,midi:e.noteNumber,noteOffVelocity:n.velocity/127,ticks:e.absoluteTime,velocity:e.velocity/127})}},u=this;o.length;)l();e.filter(function(e){return e.type===`controller`}).forEach(function(e){n.addCC({number:e.controllerType,ticks:e.absoluteTime,value:e.value/127})}),e.filter(function(e){return e.type===`pitchBend`}).forEach(function(e){n.addPitchBend({ticks:e.absoluteTime,value:e.value/2**13})});var d=e.find(function(e){return e.type===`endOfTrack`});this.endOfTrackTicks=d===void 0?void 0:d.absoluteTime}}return e.prototype.addNote=function(e){var n=s.get(this),r=new o.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},n);return Object.assign(r,e),(0,t.insert)(this.notes,r,`ticks`),this},e.prototype.addCC=function(e){var r=s.get(this),i=new n.ControlChange({controllerType:e.number},r);return delete e.number,Object.assign(i,e),Array.isArray(this.controlChanges[i.number])||(this.controlChanges[i.number]=[]),(0,t.insert)(this.controlChanges[i.number],i,`ticks`),this},e.prototype.addPitchBend=function(e){var n=s.get(this),r=new i.PitchBend({},n);return Object.assign(r,e),(0,t.insert)(this.pitchBends,r,`ticks`),this},Object.defineProperty(e.prototype,`duration`,{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,t=0;t<this.notes.length-1;t++){var n=this.notes[t].time+this.notes[t].duration;e<n&&(e=n)}return e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`durationTicks`,{get:function(){if(!this.notes.length)return 0;for(var e=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,t=0;t<this.notes.length-1;t++){var n=this.notes[t].ticks+this.notes[t].durationTicks;e<n&&(e=n)}return e},enumerable:!1,configurable:!0}),e.prototype.fromJSON=function(e){var t=this;for(var n in this.name=e.name,this.channel=e.channel,this.instrument=new a.Instrument(void 0,this),this.instrument.fromJSON(e.instrument),e.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=e.endOfTrackTicks),e.controlChanges)e.controlChanges[n]&&e.controlChanges[n].forEach(function(e){t.addCC({number:e.number,ticks:e.ticks,value:e.value})});e.notes.forEach(function(e){t.addNote({durationTicks:e.durationTicks,midi:e.midi,ticks:e.ticks,velocity:e.velocity})})},e.prototype.toJSON=function(){for(var e={},t=0;t<127;t++)this.controlChanges.hasOwnProperty(t)&&(e[t]=this.controlChanges[t].map(function(e){return e.toJSON()}));var n={channel:this.channel,controlChanges:e,pitchBends:this.pitchBends.map(function(e){return e.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(e){return e.toJSON()})};return this.endOfTrackTicks!==void 0&&(n.endOfTrackTicks=this.endOfTrackTicks),n},e}()})),A=n({flatten:()=>j});function j(e){var t=[];return M(e,t),t}function M(e,t){for(var n=0;n<e.length;n++){var r=e[n];Array.isArray(r)?M(r,t):t.push(r)}}var N=o((()=>{})),P=a((e=>{var t=e&&e.__spreadArray||function(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,a;r<i;r++)(a||!(r in t))&&(a||=Array.prototype.slice.call(t,0,r),a[r]=t[r]);return e.concat(a||Array.prototype.slice.call(t))};Object.defineProperty(e,`__esModule`,{value:!0}),e.encode=void 0;var n=b(),i=S(),a=(N(),r(A));function o(e,t){return[{absoluteTime:e.ticks,channel:t,deltaTime:0,noteNumber:e.midi,type:`noteOn`,velocity:Math.floor(e.velocity*127)},{absoluteTime:e.ticks+e.durationTicks,channel:t,deltaTime:0,noteNumber:e.midi,type:`noteOff`,velocity:Math.floor(e.noteOffVelocity*127)}]}function s(e){return(0,a.flatten)(e.notes.map(function(t){return o(t,e.channel)}))}function c(e,t){return{absoluteTime:e.ticks,channel:t,controllerType:e.number,deltaTime:0,type:`controller`,value:Math.floor(e.value*127)}}function l(e){for(var t=[],n=0;n<127;n++)e.controlChanges.hasOwnProperty(n)&&e.controlChanges[n].forEach(function(n){t.push(c(n,e.channel))});return t}function u(e,t){return{absoluteTime:e.ticks,channel:t,deltaTime:0,type:`pitchBend`,value:e.value}}function d(e){var t=[];return e.pitchBends.forEach(function(n){t.push(u(n,e.channel))}),t}function f(e){return{absoluteTime:0,channel:e.channel,deltaTime:0,programNumber:e.instrument.number,type:`programChange`}}function p(e){return{absoluteTime:0,deltaTime:0,meta:!0,text:e,type:`trackName`}}function m(e){return{absoluteTime:e.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/e.bpm),type:`setTempo`}}function h(e){return{absoluteTime:e.ticks,deltaTime:0,denominator:e.timeSignature[1],meta:!0,metronome:24,numerator:e.timeSignature[0],thirtyseconds:8,type:`timeSignature`}}function g(e){var t=i.keySignatureKeys.indexOf(e.key);return{absoluteTime:e.ticks,deltaTime:0,key:t+7,meta:!0,scale:e.scale===`major`?0:1,type:`keySignature`}}function _(e){return{absoluteTime:e.ticks,deltaTime:0,meta:!0,text:e.text,type:e.type}}function v(e){var r={header:{format:1,numTracks:e.tracks.length+1,ticksPerBeat:e.header.ppq},tracks:t([t(t(t(t([{absoluteTime:0,deltaTime:0,meta:!0,text:e.header.name,type:`trackName`}],e.header.keySignatures.map(function(e){return g(e)}),!0),e.header.meta.map(function(e){return _(e)}),!0),e.header.tempos.map(function(e){return m(e)}),!0),e.header.timeSignatures.map(function(e){return h(e)}),!0)],e.tracks.map(function(e){return t(t(t([p(e.name),f(e)],s(e),!0),l(e),!0),d(e),!0)}),!0)};return r.tracks=r.tracks.map(function(e){e=e.sort(function(e,t){return e.absoluteTime-t.absoluteTime});var t=0;return e.forEach(function(e){e.deltaTime=e.absoluteTime-t,t=e.absoluteTime,delete e.absoluteTime}),e.push({deltaTime:0,meta:!0,type:`endOfTrack`}),e}),new Uint8Array((0,n.writeMidi)(r))}e.encode=v})),F=a((e=>{var t=e&&e.__awaiter||function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},n=e&&e.__generator||function(e,t){var n={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,i,a,o;return o={next:s(0),throw:s(1),return:s(2)},typeof Symbol==`function`&&(o[Symbol.iterator]=function(){return this}),o;function s(e){return function(t){return c([e,t])}}function c(o){if(r)throw TypeError(`Generator is already executing.`);for(;n;)try{if(r=1,i&&(a=o[0]&2?i.return:o[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[o[0]&2,a.value]),o[0]){case 0:case 1:a=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,i=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if((a=n.trys,!(a=a.length>0&&a[a.length-1]))&&(o[0]===6||o[0]===2)){n=0;continue}if(o[0]===3&&(!a||o[1]>a[0]&&o[1]<a[3])){n.label=o[1];break}if(o[0]===6&&n.label<a[1]){n.label=a[1],a=o;break}if(a&&n.label<a[2]){n.label=a[2],n.ops.push(o);break}a[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],i=0}finally{r=a=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}};Object.defineProperty(e,`__esModule`,{value:!0}),e.Header=e.Track=e.Midi=void 0;var r=b(),i=S(),a=k(),o=P();e.Midi=function(){function e(e){var t=this,n=null;if(e){var o=e instanceof ArrayBuffer?new Uint8Array(e):e;n=(0,r.parseMidi)(o),n.tracks.forEach(function(e){var t=0;e.forEach(function(e){t+=e.deltaTime,e.absoluteTime=t})}),n.tracks=l(n.tracks)}this.header=new i.Header(n),this.tracks=[],e&&(this.tracks=n.tracks.map(function(e){return new a.Track(e,t.header)}),n.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return e.fromUrl=function(r){return t(this,void 0,void 0,function(){var t,i;return n(this,function(n){switch(n.label){case 0:return[4,fetch(r)];case 1:return t=n.sent(),t.ok?[4,t.arrayBuffer()]:[3,3];case 2:return i=n.sent(),[2,new e(i)];case 3:throw Error(`Could not load '${r}'`)}})})},Object.defineProperty(e.prototype,`name`,{get:function(){return this.header.name},set:function(e){this.header.name=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`duration`,{get:function(){var e=this.tracks.map(function(e){return e.duration});return Math.max.apply(Math,e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`durationTicks`,{get:function(){var e=this.tracks.map(function(e){return e.durationTicks});return Math.max.apply(Math,e)},enumerable:!1,configurable:!0}),e.prototype.addTrack=function(){var e=new a.Track(void 0,this.header);return this.tracks.push(e),e},e.prototype.toArray=function(){return(0,o.encode)(this)},e.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(e){return e.toJSON()})}},e.prototype.fromJSON=function(e){var t=this;this.header=new i.Header,this.header.fromJSON(e.header),this.tracks=e.tracks.map(function(e){var n=new a.Track(void 0,t.header);return n.fromJSON(e),n})},e.prototype.clone=function(){var t=new e;return t.fromJSON(this.toJSON()),t},e}();var s=k();Object.defineProperty(e,`Track`,{enumerable:!0,get:function(){return s.Track}});var c=S();Object.defineProperty(e,`Header`,{enumerable:!0,get:function(){return c.Header}});function l(e){for(var t=[],n=0;n<e.length;n++)for(var r=t.length,i=new Map,a=Array(16).fill(0),o=0,s=e[n];o<s.length;o++){var c=s[o],l=r,u=c.channel;if(u!==void 0){c.type===`programChange`&&(a[u]=c.programNumber);var d=`${a[u]} ${u}`;i.has(d)?l=i.get(d):(l=r+i.size,i.set(d,l))}t[l]||t.push([]),t[l].push(c)}return t}}))();const I=e=>{let t=new F.Midi(e),n=t.tracks.flatMap((e,t)=>e.notes.map(n=>({startSec:n.time,durationSec:n.duration,endSec:n.time+n.duration,pitch:n.midi,velocity:n.velocity,trackIndex:t,channel:e.channel})));return n.sort((e,t)=>e.startSec-t.startSec||e.pitch-t.pitch),{notes:n,durationSec:t.duration,tracksCount:t.tracks.length}},L=({isPlaying:e,currentTimeSec:n,durationSec:r,onPlay:i,onPause:a,onStop:o,onSeek:c})=>{let l=r>0?r:0;return(0,h.jsxs)(`div`,{style:{display:`flex`,gap:10,alignItems:`center`,padding:12,border:`1px solid #0002`,borderRadius:12},children:[(0,h.jsx)(t,{type:`text`,size:`large`,onClick:e?a:i,disabled:l===0,icon:e?(0,h.jsx)(u,{size:30,color:`#1890ff`}):(0,h.jsx)(d,{size:30,color:`#52c41a`})}),(0,h.jsx)(t,{type:`text`,size:`large`,onClick:o,disabled:l===0,icon:(0,h.jsx)(f,{size:30,color:`#ff4d4f`})}),(0,h.jsx)(s,{type:`range`,min:0,max:l,step:.01,value:Math.min(n,l),onChange:e=>c(Number(e.target.value)),style:{flex:1},disabled:l===0}),(0,h.jsxs)(`div`,{style:{fontFamily:`monospace`,fontSize:12,opacity:.8,minWidth:140,textAlign:`right`},children:[n.toFixed(2),` / `,r.toFixed(2),` сек`]})]})},R=e=>{let t=e.durationSec,[n,r]=(0,m.useState)(!1),[i,a]=(0,m.useState)(0),o=(0,m.useRef)(null),s=(0,m.useRef)(0),c=(0,m.useRef)(0),l=(0,m.useRef)(null),u=(0,m.useRef)(0);(0,m.useEffect)(()=>{u.current=e.durationSec},[e.durationSec]);let d=(0,m.useCallback)(()=>{o.current!==null&&(cancelAnimationFrame(o.current),o.current=null)},[]),f=(0,m.useCallback)(e=>{let t=u.current;return e<0?0:e>t?t:e},[]);(0,m.useEffect)(()=>{l.current=()=>{let e=(performance.now()-s.current)/1e3,t=f(c.current+e);a(t);let n=u.current;if(n>0&&t>=n){r(!1),d();return}o.current=requestAnimationFrame(()=>{l.current&&l.current()})}},[f,d]);let p=(0,m.useCallback)(()=>{n||u.current<=0||(d(),r(!0),s.current=performance.now(),c.current=i,o.current=requestAnimationFrame(()=>{l.current&&l.current()}))},[n,i,d]),h=(0,m.useCallback)(()=>{n&&(r(!1),d(),c.current=i)},[n,i,d]),g=(0,m.useCallback)(()=>{r(!1),d(),a(0),c.current=0},[d]),_=(0,m.useCallback)(e=>{let t=f(e);a(t),c.current=t,s.current=performance.now()},[f]);return(0,m.useEffect)(()=>()=>d(),[d]),{isPlaying:n,currentTimeSec:i,durationSec:t,play:p,pause:h,stop:g,seek:_,toggle:n?h:p}},z=({midiInfo:e,parsed:t})=>(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`div`,{style:{marginTop:12,opacity:.8},children:(0,h.jsxs)(`h2`,{children:[`Загружен: `,e.name,` (`,e.size,` байт)`]})}),(0,h.jsxs)(`div`,{style:{marginTop:12,opacity:.9},children:[(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`b`,{children:`Файл:`}),` `,e.name]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`b`,{children:`Длительность:`}),` `,t.durationSec.toFixed(2),` сек`]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`b`,{children:`Треков:`}),` `,t.tracksCount]}),(0,h.jsxs)(`div`,{children:[(0,h.jsx)(`b`,{children:`Нот:`}),` `,t.notes.length]}),(0,h.jsx)(`div`,{style:{marginTop:10,fontFamily:`monospace`,fontSize:12,whiteSpace:`pre-wrap`},children:t.notes.slice(0,10).map((e,t)=>(0,h.jsxs)(`div`,{children:[`t=`,e.startSec.toFixed(3),`..`,e.endSec.toFixed(3),` pitch=`,e.pitch,` vel=`,e.velocity.toFixed(2),` track=`,e.trackIndex]},t))})]})]});var B=()=>{let[e,t]=(0,m.useState)(null),[n,r]=(0,m.useState)(null),i=R({durationSec:n?.durationSec??0});return(0,h.jsxs)(`div`,{className:p.container,children:[(0,h.jsx)(_,{disabled:i.isPlaying,onMidiLoaded:e=>{i.stop(),t({name:e.file.name,size:e.arrayBuffer.byteLength}),r(I(e.arrayBuffer))}}),(0,h.jsx)(`hr`,{}),(0,h.jsx)(L,{isPlaying:i.isPlaying,onPlay:i.play,onPause:i.pause,onStop:i.stop,onSeek:i.seek,durationSec:i.durationSec,currentTimeSec:i.currentTimeSec}),e&&n&&(0,h.jsx)(z,{midiInfo:e,parsed:n})]})};export{B as default};